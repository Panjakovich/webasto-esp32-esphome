# Webasto ESP32 Controller (ESPHome)

ESPHome-конфиг для управления жидкостным подогревателем Webasto на базе ESP32 с:

- **полностью автономным циклом работы** (розжиг → работа → охлаждение),
- **интеграцией в Home Assistant**,
- **автоматическим выбором мощности** по нагрузке системы отопления,
- **PWM‑управлением вентилятором и водяной помпой**,
- **байпас‑клапаном** для быстрого набора температуры,
- продуманной **системой защит** (перегрев, срыв пламени, ошибка датчика, отсутствие роста температуры).

Основной конфиг: `webasto_esp32_auto.yaml`

> **ВНИМАНИЕ:** Проект рассчитан на пользователей, уверенно работающих с автомобильным 12 В оборудованием, MOSFET‑ключами и безопасностью. Любые работы вы выполняете на свой страх и риск.

---

## Возможности

- **Полный автономный цикл**:
  - передрозжиг (нагрев свечи, мягкий старт вентилятора),
  - розжиг с контролем по току свечи (ACS712),
  - рабочий режим с дозированной подачей топлива (импульсы на насос),
  - контролируемое охлаждение после остановки.

- **Интеграция в Home Assistant**:
  - `Webasto Master Switch` — включение/выключение котла,
  - `Target Power` (`Low` / `Medium` / `High`) — целевая мощность,
  - текстовый статус (`Heater Status`) и код состояния,
  - телеметрия: температура Webasto (NTC), подача/обратка (DS18B20), ΔT, ток свечи, частота насоса, счётчик неудачных розжигов.

- **Автоматическое управление мощностью**:
  - два датчика DS18B20: на подаче и обратке радиаторного контура,
  - расчёт `ΔT = Flow - Return` и поддержание подачи около 50 °C,
  - при высокой нагрузке (большой ΔT или холодная подача) — повышение мощности,
  - при малой нагрузке (малый ΔT и горячая подача) — снижение мощности,
  - защита от сажи: ограничение длительной работы в режиме `Low` (периодические «прожиги»).

- **PWM‑управление помпой и вентилятором**:
  - вентилятор Webasto — 20 кГц PWM (тихая работа),
  - водяная помпа — PWM‑управление, уровень зависит от выбранной мощности (`Low`/`Medium`/`High`).

- **Байпас‑клапан**:
  - управляемый клапан между подачей и обраткой,
  - в фазе розжига — открыт, образует малый контур вокруг Webasto для быстрого набора температуры,
  - в работе — логика открытия/закрытия по ΔT и температуре подачи (поддержание стабильного горения и температуры).

- **Защита и диагностика**:
  - перегрев по NTC Webasto (`> 92 °C`) → аварийное отключение и продувка,
  - контроль срыва пламени по току свечи с фильтрацией,
  - контроль роста температуры при розжиге (если за N секунд температура почти не выросла — ошибка),
  - обработка ошибки датчика температуры (NaN),
  - ограничение числа подряд неудачных запусков с возможностью сброса.

---

## Аппаратная часть

### 1. Контроллер

- **ESP32** (WROOM‑32/DevKit): 1 шт.
- Питание через надёжный DC‑DC (12 В → 5 В) с запасом по току.

### 2. Силовые ключи

Все силовые нагрузки работают от 12 В, управляются ESP32 через N‑канальные MOSFET (логический уровень, Rds(on) при 3.3 В) либо через промежуточные драйверы/оптопары.

Рекомендуемые MOSFET:

- Свеча накала: IRLB3034 (20 А+, радиатор обязателен).
- Вентилятор / помпа / топливный насос: IRLZ44N или аналогичные logic‑level транзисторы (5–10 А).

Обязательны:

- обратные диоды (например, 1N4007) на индуктивные нагрузки (моторы, помпа, насос),
- общий «звёздный» минус для силовой и логической земли,
- мощный электролитический конденсатор на линии 12 В (1000–2200 мкФ) рядом со свечой/насосом.

### 3. Датчики

- **NTC Webasto** (штатный датчик в котле):
  - подключается по схеме делителя 3.3 В → NTC → ADC → резистор 10 кОм → GND,
  - используется `ntc`‑сенсор в ESPHome для пересчёта в градусы.

- **ACS712 (20 A)** — ток свечи / пламя:
  - включается в разрыв цепи свечи,
  - выход модуля (0–5 В) через делитель (пример: 2 кОм / 3.3 кОм) приводится к 0–3.3 В и подаётся на ADC ESP32.

- **Два DS18B20**:
  - один на подаче к радиаторам (Flow),
  - один на обратке от радиаторов (Return),
  - подключение по стандартной схеме OneWire с подтяжкой к 3.3 В (4.7 кОм).

### 4. Байпас‑клапан

- Электромагнитный (или моторный) клапан, замыкающий подачу и обратку рядом с котлом.
- Управление по GPIO через MOSFET / реле.

---

## Структура репозитория

- `webasto_esp32_auto.yaml` — основной конфиг ESPHome для Webasto + Home Assistant.
- `Task 4 ai.docx` — исходное текстовое описание/документация (если нужно, можно удалить из публичного репо).

---

## Настройка и запуск

### 1. Подготовка ESPHome

1. Установите ESPHome (через Docker, `pip` или аддон Home Assistant).
2. Скопируйте файл `webasto_esp32_auto.yaml` в каталог проектов ESPHome.
3. Создайте `secrets.yaml` и добавьте туда:

```yaml
wifi_ssid: "ВАШ_SSID"
wifi_password: "ВАШ_ПАРОЛЬ"
webasto_api_key: "API_KEY_32_BYTES"
webasto_ota_password: "СЛОЖНЫЙ_ПАРОЛЬ_ДЛЯ_OTA"
```

4. В `webasto_esp32_auto.yaml` укажите **реальные адреса DS18B20** (они будут видны в логах ESPHome после первого запуска).

### 2. Компиляция и прошивка

В каталоге ESPHome:

```bash
esphome run webasto_esp32_auto.yaml
```

Первый раз — по USB, далее можно по OTA.

---

## Интеграция в Home Assistant

После прошивки ESPHome‑узел появится в разделе **Settings → Devices & Services → ESPHome**.

Основные сущности:

- `switch.webasto_master_switch` — включение/выключение котла.
- `select.target_power` — ручной выбор мощности (при необходимости, автоалгоритм всё равно будет её корректировать).
- `sensor.water_temperature` — температура котла Webasto по NTC.
- `sensor.flow_temperature` / `sensor.return_temperature` / `sensor.delta_t_flow_return`.
- `sensor.heater_state_code` и `text_sensor.heater_status`.
- `sensor.fuel_frequency`, `sensor.ignite_fail_count`, `sensor.glow_plug_current`.
- `switch.bypass_valve`, `switch.webasto_bench_mode`, `switch.webasto_reset_error`.

Вы можете использовать эти сущности в автоматизациях HA (например, для включения котла по расписанию или при падении температуры в доме).

---

## Логика автоматики (кратко)

- **Цикл запуска**:
  - включение помпы и вентилятора на малой скорости,
  - включение свечи накала,
  - ожидание 45 с и переход в фазу розжига,
  - отслеживание тока свечи по ACS712; при успешном розжиге — выключение свечи и переход в рабочий режим.

- **Авто‑мощность**:
  - рассчитывается по ΔT и температуре подачи:
    - `High` — если подача холодная (`< 45 °C`) или ΔT большой (`> ~8 °C`),
    - `Medium` — при средней нагрузке (подача около 45–55 °C и ΔT ~3–8 °C),
    - `Low` — при горячей подаче (`> 55 °C`) и малом ΔT (`< 3 °C`).
  - при слишком долгой работе в `Low` (по умолчанию >15 мин) мощность принудительно поднимается до `Medium` (борьба с сажей).

- **Байпас**:
  - в преднагреве/розжиге — всегда открыт (малый контур),
  - в работе:
    - при малой нагрузке (малый ΔT и невысокая подача) — открыт, чтобы котёл не «захлёбывался» большим контуром,
    - при большой нагрузке/перегреве подачи — закрывается, максимально гоняя тепло в основной контур.

---

## Настройка под свою систему

В начале `webasto_esp32_auto.yaml` есть блок `substitutions`:

- **Пины** (`pin_glow_plug`, `pin_fan`, `pin_fuel_pump`, `pin_water_pump`, `pin_ntc_sensor`, `pin_flame_sensor`, `pin_dallas`, `pin_bypass`) — скорректируйте под свою разводку.
- **Пороги**:
  - `overheat_temp_c` — температура аварийного перегрева котла.
  - `radiator_low_c`, `radiator_high_c` — диапазон, в котором хотим держать температуру подачи на батареи (по умолчанию около 50 °C).
  - `flame_*_threshold_*` — пороги для тока свечи (подбираются по логам).
  - `ignition_timeout_ms`, `min_temp_rise_c` — критерий успешного розжига по росту температуры.

Рекомендуется сначала:

1. Запустить котёл в безопасном месте.
2. Посмотреть графики температуры и тока (в HA/ESPHome).
3. Подправить пороги так, чтобы:
   - не было ложных аварий,
   - не происходил «закип» контура,
   - не было длительной работы на слишком низкой температуре горения.

---

## Безопасность

- Обязательно используйте **предохранители** на линиях питания (общий 20 А на входе + отдельные по цепям, если возможно).
- Следите за **температурой MOSFET и проводки** (особенно свечи и вентилятора).
- Не отключайте/не игнорируйте защиту по температуре и ошибкам датчиков.
- Тестируйте сначала на стенде с нагрузочными резисторами/лампами, затем в реальной системе.

---

## Лицензия

Проект распространяется «как есть», без каких‑либо гарантий.  
Использование в ответственных системах отопления — на ваше усмотрение и риск.

